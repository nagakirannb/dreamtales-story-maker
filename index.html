<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DreamTales ‚Äì Bedtime Story Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1d3b" />
  <style>
    :root {
      --midnight: #0b1d3b;
      --yellow: #ffd66b;
      --card-bg: #ffffff;
      --border: #d0d6f0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e6ecff 0, #f7f8ff 40%, #fdfdff 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      margin: 16px;
      padding: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fff 0, #ffe89a 40%, #f7d05a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .brand-text {
      font-weight: 700;
      color: var(--midnight);
      font-size: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    @media (max-width: 800px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 18px 18px 22px;
      border: 1px solid rgba(255, 255, 255, 0.7);
    }

    h1 {
      font-size: 24px;
      margin: 0 0 6px;
      color: var(--midnight);
    }

    .subtitle {
      color: #555;
      margin-bottom: 16px;
      font-size: 14px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: #222;
      font-size: 14px;
    }

    input, select, button {
      width: 100%;
      margin-top: 6px;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #fdfdff;
    }

    input:focus, select:focus {
      outline: 2px solid #c0ccff;
      border-color: #a7b6ff;
    }

    button {
      margin-top: 18px;
      background: var(--yellow);
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease;
      color: #42210b;
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.55;
      cursor: wait;
      box-shadow: none;
      transform: none;
    }

    .status {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    .storybook {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #fdf7ec;
  border-radius: 22px;
  border: 1px solid #f4e3c2;
  box-shadow:
    0 18px 35px rgba(148, 131, 104, 0.35),
    0 0 0 1px rgba(255, 255, 255, 0.7);
  padding: 14px 16px 18px;
  position: relative;
  overflow: hidden;
}

    /* subtle spine down the middle */
.storybook::before {
  content: "";
  position: absolute;
  top: 10px;
  bottom: 10px;
  left: 50%;
  width: 3px;
  transform: translateX(-50%);
  background: linear-gradient(
    to bottom,
    rgba(255, 255, 255, 0.8),
    rgba(0, 0, 0, 0.06),
    rgba(255, 255, 255, 0.8)
  );
  opacity: 0.45;
  pointer-events: none;
}

.storybook-header {
  position: relative;
  z-index: 1;
}

    .storybook-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--midnight);
    }

    .storybook-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 214, 107, 0.3);
      color: #7a5a0a;
    }

    .storybook-body {
  flex: 1;
  overflow: hidden;
  margin-top: 8px;
  padding-right: 4px;
  position: relative;
}

/* The "paper" for each page */
.storybook-page {
  width: 100%;
  height: 100%;
  overflow-y: auto;
  line-height: 1.7;
  font-size: 15px;
  color: #3b2b1a;
  white-space: pre-wrap;
  background: radial-gradient(circle at top, #fffaf0 0, #fff4dd 45%, #ffeccd 100%);
  border-radius: 16px;
  padding: 14px 18px 16px;
  box-shadow:
    inset 3px 0 6px rgba(255, 255, 255, 0.7),
    inset -3px 0 6px rgba(210, 180, 140, 0.35);
}

    /* subtle fade/slide for page turns */
.page-fade {
  animation: pageFade 0.22s ease-out;
}

@keyframes pageFade {
  from {
    opacity: 0;
    transform: translateX(8px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

    .page-image {
  width: 100%;
  max-height: 260px;
  object-fit: cover;
  border-radius: 16px;
  margin-bottom: 12px;
  background: #eee;
  box-shadow:
    0 8px 18px rgba(0, 0, 0, 0.18),
    0 0 0 1px rgba(255, 255, 255, 0.8);
}

    .storybook-placeholder {
      margin-top: 30px;
      text-align: center;
      color: #777;
      font-size: 13px;
    }

    .moral-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fff9da;
      border: 1px dashed #f0d16b;
      font-size: 13px;
      color: #4a3907;
    }

    .moral-label {
      font-weight: 700;
      margin-right: 4px;
    }

    .storybook-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
      border-top: 1px dashed #d0d6f0;
      padding-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(11, 29, 59, 0.06);
      font-size: 11px;
      color: #444;
    }

    .pager-controls {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .pager-btn {
      border-radius: 999px;
      border: 1px solid #ccd2f5;
      background: #ffffff;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
    }

    .pager-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="brand">
      <div class="brand-icon">üåô</div>
      <div class="brand-text">DreamTales ‚Äì Bedtime Story Maker</div>
    </div>

    <div class="layout">
      <!-- LEFT: form -->
      <div class="card">
        <h1>Personalized Bedtime Stories</h1>
        <div class="subtitle">
          Create soothing, personalized bedtime stories in seconds ‚Äì just add your child‚Äôs name and a moral.
        </div>

        <label>Child's Name</label>
        <input id="childName" placeholder="e.g., Aby" />

        <label>Age</label>
        <input id="age" type="number" min="2" max="12" placeholder="e.g., 6" />

        <label>Theme (moral)</label>
        <select id="theme">
          <option>Kindness</option>
          <option>Honesty</option>
          <option>Courage</option>
          <option>Sharing</option>
          <option>Gratitude</option>
        </select>

        <label>Style</label>
        <select id="style">
          <option>Calm & Gentle</option>
          <option>Funny</option>
          <option>Magical Adventure</option>
          <option>Animal Friends</option>
        </select>

        <label>Story Length</label>
        <select id="length">
          <option>Short</option>
          <option selected>Medium</option>
          <option>Long</option>
        </select>

        <button id="generateBtn">‚ú® Generate Story</button>

        <div id="status" class="status"></div>
      </div>

      <!-- RIGHT: story viewer -->
      <div class="storybook">
        <div class="storybook-header">
          <div class="storybook-title" id="storybookTitle">
            Your storybook will appear here
          </div>
          <div class="storybook-pill" id="storybookPill">
            Ready for bedtime
          </div>
        </div>

        <div class="storybook-body">
          <div class="storybook-page" id="storybookPage">
            <div class="storybook-placeholder" id="storybookPlaceholder">
              üí´ When you generate a story, it will be displayed here in a book-style view.
              <br /><br />
              Page 1 will show a cover illustration when available.
            </div>
          </div>
        </div>

        <div class="moral-box" id="moralBox" style="display:none;">
          <span class="moral-label">Moral:</span>
          <span id="moralText"></span>
        </div>

        <div class="storybook-footer">
          <span class="badge">Tip: Turn your phone sideways for a wider ‚Äústorybook‚Äù feel.</span>
          <div class="pager-controls">
            <button id="prevPage" class="pager-btn" disabled>‚Äπ Prev</button>
            <span id="pageInfo">Page 0 of 0</span>
            <button id="nextPage" class="pager-btn" disabled>Next ‚Ä∫</button>
          </div>
        </div>
      </div>
    </div>

    <div class="status" style="text-align:center; margin-top:10px;">
      Prototype preview ‚Äì illustrations are generated on the server to keep your API key safe.
    </div>
  </div>

  <script>
    let storyPages = [];
    let currentPageIndex = 0;
    let currentMoralLine = "";
    let currentIllustrationPrompts = [];
    let coverImageUrl = null;

    const btn = document.getElementById("generateBtn");
    const statusEl = document.getElementById("status");
    const titleEl = document.getElementById("storybookTitle");
    const pillEl = document.getElementById("storybookPill");
    const pageEl = document.getElementById("storybookPage");
    const placeholderEl = document.getElementById("storybookPlaceholder");
    const moralBox = document.getElementById("moralBox");
    const moralText = document.getElementById("moralText");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

   function renderPage() {
  if (storyPages.length === 0) {
    pageEl.innerHTML = "";
    placeholderEl.style.display = "block";
    pageInfo.textContent = "Page 0 of 0";
    prevPageBtn.disabled = true;
    nextPageBtn.disabled = true;
    moralBox.style.display = "none";
    return;
  }

  placeholderEl.style.display = "none";
  pageEl.innerHTML = "";

  const isFirstPage = currentPageIndex === 0;
  const isLastPage = currentPageIndex === storyPages.length - 1;

  // Cover image only on first page
  if (isFirstPage && coverImageUrl) {
    const img = document.createElement("img");
    img.src = coverImageUrl;
    img.alt = "Story cover illustration";
    img.className = "page-image";
    pageEl.appendChild(img);
  }

  const pageText = storyPages[currentPageIndex];
  pageText.forEach(sentence => {
    const p = document.createElement("p");
    p.textContent = sentence;
    pageEl.appendChild(p);
  });

  // trigger small page-turn animation
  pageEl.classList.remove("page-fade");
  // force reflow to restart animation
  void pageEl.offsetWidth;
  pageEl.classList.add("page-fade");

  pageInfo.textContent = `Page ${currentPageIndex + 1} of ${storyPages.length}`;
  prevPageBtn.disabled = currentPageIndex === 0;
  nextPageBtn.disabled = currentPageIndex === storyPages.length - 1;

  if (isLastPage && currentMoralLine) {
    moralText.textContent = currentMoralLine;
    moralBox.style.display = "block";
  } else {
    moralBox.style.display = "none";
  }
}


    prevPageBtn.addEventListener("click", () => {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        renderPage();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPageIndex < storyPages.length - 1) {
        currentPageIndex++;
        renderPage();
      }
    });

    function sentenceRangeForLength(length) {
      if (length === "Short") return "4‚Äì6 sentences";
      if (length === "Long") return "14‚Äì20 sentences";
      return "8‚Äì12 sentences"; // Medium
    }

    async function generateCoverIllustration(childName, age, theme, illustrationPrompts) {
      if (!illustrationPrompts || illustrationPrompts.length === 0) return;

      const firstPrompt = illustrationPrompts[0];
      const styleHint =
        "children's book illustration, soft watercolor, warm pastel colors, cute and gentle, simple background, no text, no words, 4:5 aspect ratio";

      const prompt = `${firstPrompt}. ${styleHint}. Story about ${childName}, a ${age}-year-old child learning about ${theme}.`;

      try {
        statusEl.textContent += " | Generating cover illustration‚Ä¶";
        const response = await fetch("/.netlify/functions/illustrations", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ prompt })
});

let dataText = await response.text();
let data;

try {
  data = dataText ? JSON.parse(dataText) : {};
} catch (e) {
  console.error("Non-JSON cover response:", dataText);
  statusEl.textContent += " (cover image error: non-JSON response from server)";
  return;
}

if (!response.ok || !data.url) {
  console.error("Cover illustration error:", data);
  statusEl.textContent += " (cover image error: " + (data.error || "unknown") + ")";
  return;
}


        coverImageUrl = data.url;
        renderPage();
        statusEl.textContent += " | Cover ready üåü";
      } catch (err) {
        console.error("Cover illustration error:", err);
        statusEl.textContent += " (error loading cover image: " + err.message + ")";
      }
    }

    async function generateStory() {
      const childName = document.getElementById("childName").value.trim();
      const age = document.getElementById("age").value.trim();
      const theme = document.getElementById("theme").value;
      const style = document.getElementById("style").value;
      const length = document.getElementById("length").value;

      if (!childName || !age) {
        alert("Please enter the child's name and age.");
        return;
      }

      btn.disabled = true;
      statusEl.textContent = "Creating a magical story...";
      titleEl.textContent = "Writing a story for " + childName + "‚Ä¶";
      pillEl.textContent = theme + " ‚Ä¢ " + style;
      storyPages = [];
      currentPageIndex = 0;
      currentMoralLine = "";
      currentIllustrationPrompts = [];
      coverImageUrl = null;
      renderPage();

      const range = sentenceRangeForLength(length);

      const userContent = `
Create a bedtime story for a child.

Child's Name: ${childName}
Age: ${age}
Theme (moral): ${theme}
Style: ${style}
Length: ${length}

Rules:
1. Use simple, age-appropriate language for a child of this age.
2. Include the child‚Äôs name 4‚Äì6 times naturally.
3. Keep the tone calm, gentle, and encouraging, suitable for bedtime.
4. Add 1‚Äì2 cute or magical elements (e.g., friendly animals, stars, moon, talking toys).
5. Write the main story in ${range}, as one continuous block of text. Do not label the sentences.
6. At the end, write one clear sentence starting exactly with 'Moral:' that explains the lesson of the story.
7. After the moral, add a new section titled 'Illustration Prompts:' and list 4 bullet-point prompts describing key scenes for an illustrator or image model.
      `.trim();

      try {
        const response = await fetch("/.netlify/functions/story", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content:
                  "You are a gentle, creative kids‚Äô bedtime story writer. You write safe, soothing, age-appropriate stories for children. Your stories always have a clear positive moral. You avoid anything scary or disturbing."
              },
              { role: "user", content: userContent }
            ]
          })
        });

        const data = await response.json();

        if (!response.ok) {
          console.error("Story API error:", data);
          throw new Error(data.error?.message || data.error || "Story API error");
        }

        let storyRaw = data.choices?.[0]?.message?.content?.trim() || "No story generated.";

        // Extract moral + illustration prompts
        let mainText = storyRaw;
        let moralLine = "";
        let illustrationPrompts = [];

        const moralMatch = storyRaw.match(/Moral:\s*(.*)/i);
        if (moralMatch) {
          moralLine = moralMatch[1].trim();
        }

        const illuSplit = mainText.split(/Illustration Prompts:/i);
        if (illuSplit.length > 1) {
          mainText = illuSplit[0].trim();
          const illuBlock = illuSplit[1];
          const lines = illuBlock
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.length > 0);

          illustrationPrompts = lines
            .filter(l => !/^Moral:/i.test(l))
            .map(l => l.replace(/^[\-‚Ä¢\d. ]+/, ""))
            .slice(0, 6);
        }

        mainText = mainText.replace(/Moral:\s*.*$/mi, "").trim();

        const sentenceRegex = /[^.!?]+[.!?]/g;
        const matches = mainText.match(sentenceRegex);
        const sentences = (matches || [mainText])
          .map(s => s.trim())
          .filter(s => s.length > 0);

        storyPages = sentences.map(s => [s]);
        currentMoralLine = moralLine;
        currentIllustrationPrompts = illustrationPrompts;
        currentPageIndex = 0;
        renderPage();

        titleEl.textContent = "Bedtime story for " + childName;
        statusEl.textContent = "Story ready ‚ú® Cover will appear if image generation succeeds.";

        // Generate a single cover illustration (non-blocking for reading)
        if (currentIllustrationPrompts.length > 0) {
          generateCoverIllustration(childName, age, theme, currentIllustrationPrompts);
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Something went wrong: " + err.message;
        titleEl.textContent = "Could not generate story";
        storyPages = [];
        currentPageIndex = 0;
        currentMoralLine = "";
        currentIllustrationPrompts = [];
        coverImageUrl = null;
        renderPage();
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener("click", generateStory);

    // Register service worker for PWA (you can comment this out while developing if caching is annoying)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    }
  </script>
</body>
</html>





