<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DreamTales ‚Äì Bedtime Story Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b1d3b" />
  <style>
    :root {
      --midnight: #0b1d3b;
      --yellow: #ffd66b;
      --card-bg: #ffffff;
      --border: #d0d6f0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e6ecff 0, #f7f8ff 40%, #fdfdff 100%);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app-shell {
      width: 100%;
      max-width: 960px;
      margin: 16px;
      padding: 12px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fff 0, #ffe89a 40%, #f7d05a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .brand-text {
      font-weight: 700;
      color: var(--midnight);
      font-size: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    @media (max-width: 800px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      padding: 18px 18px 22px;
      border: 1px solid rgba(255, 255, 255, 0.7);
    }

    h1 {
      font-size: 24px;
      margin: 0 0 6px;
      color: var(--midnight);
    }

    .subtitle {
      color: #555;
      margin-bottom: 16px;
      font-size: 14px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: #222;
      font-size: 14px;
    }

    input, select, button {
      width: 100%;
      margin-top: 6px;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-family: inherit;
      background: #fdfdff;
    }

    input:focus, select:focus {
      outline: 2px solid #c0ccff;
      border-color: #a7b6ff;
    }

    button {
      margin-top: 18px;
      background: var(--yellow);
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease;
      color: #42210b;
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.55;
      cursor: wait;
      box-shadow: none;
      transform: none;
    }

    .auth-btn {
      width: auto;
      padding-inline: 14px;
      margin-top: 0;
      font-size: 13px;
      white-space: nowrap;
    }

    .status {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }

    /* MODERN MINIMAL STORYBOOK */

    .storybook {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(255, 255, 255, 0.9);
      padding: 16px 16px 18px;
      position: relative;
      overflow: hidden;
    }

    .storybook-header {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .storybook-title {
      font-weight: 700;
      font-size: 16px;
      color: var(--midnight);
    }

    .storybook-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255, 214, 107, 0.2);
      color: #7a5a0a;
    }

    .storybook-body {
      flex: 1;
      overflow: hidden;
      margin-top: 8px;
      padding-right: 4px;
      position: relative;
    }

    .storybook-page {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      line-height: 1.6;
      font-size: 14.5px;
      color: #111827;
      white-space: pre-wrap;
      background: #f9fafb;
      border-radius: 14px;
      padding: 14px 18px 16px;
      box-shadow:
        inset 0 0 0 1px rgba(229, 231, 235, 0.9),
        0 0 0 1px rgba(255, 255, 255, 0.8);
    }

    .page-fade {
      animation: pageFade 0.2s ease-out;
    }

    @keyframes pageFade {
      from {
        opacity: 0;
        transform: translateX(6px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .page-image {
      width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      margin-bottom: 12px;
      background: #e5e7eb;
      box-shadow:
        0 10px 24px rgba(15, 23, 42, 0.18),
        0 0 0 1px rgba(255, 255, 255, 0.9);
    }

    .storybook-placeholder {
      margin-top: 30px;
      text-align: center;
      color: #777;
      font-size: 13px;
    }

    .moral-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fff9da;
      border: 1px dashed #f0d16b;
      font-size: 13px;
      color: #4a3907;
    }

    .moral-label {
      font-weight: 700;
      margin-right: 4px;
    }

    .storybook-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
      border-top: 1px dashed #d0d6f0;
      padding-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(11, 29, 59, 0.06);
      font-size: 11px;
      color: #444;
    }

    .pager-controls {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .pager-btn {
      border-radius: 999px;
      border: 1px solid #ccd2f5;
      background: #ffffff;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
    }

    .pager-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .saved-stories {
      margin-top: 16px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 14px;
      padding: 12px 16px 14px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
      font-size: 13px;
    }

    .saved-stories h2 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--midnight);
    }

    .saved-stories-note {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .saved-stories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .saved-story-item {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      font-size: 12px;
      color: #374151;
      display: inline-flex;
      flex-direction: column;
      gap: 2px;
      min-width: 140px;
    }

    .saved-story-item span:first-child {
      font-weight: 600;
    }

    .saved-story-meta {
      font-size: 11px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="brand">
      <div style="display:flex; align-items:center; gap:10px; flex:1;">
        <div class="brand-icon">üåô</div>
        <div class="brand-text">DreamTales ‚Äì Bedtime Story Maker</div>
      </div>
      <button id="authBtn" class="auth-btn">Sign in</button>
    </div>

    <div class="layout">
      <!-- LEFT: form -->
      <div class="card">
        <h1>Personalized Bedtime Stories</h1>
        <div class="subtitle">
          Create soothing, personalized bedtime stories in seconds ‚Äì just add your child‚Äôs name and a moral.
        </div>

        <label>Child's Name</label>
        <input id="childName" placeholder="e.g., Aby" />

        <label>Age</label>
        <input id="age" type="number" min="2" max="12" placeholder="e.g., 6" />

        <label>Theme (moral)</label>
        <select id="theme">
          <option>Kindness</option>
          <option>Honesty</option>
          <option>Courage</option>
          <option>Sharing</option>
          <option>Gratitude</option>
        </select>

        <label>Style</label>
        <select id="style">
          <option>Calm & Gentle</option>
          <option>Funny</option>
          <option>Magical Adventure</option>
          <option>Animal Friends</option>
        </select>

        <label>Story Length</label>
        <select id="length">
          <option>Short</option>
          <option selected>Medium</option>
          <option>Long</option>
        </select>

        <button id="generateBtn">‚ú® Generate Story</button>

        <div id="status" class="status"></div>
      </div>

      <!-- RIGHT: story viewer -->
      <div class="storybook">
        <div class="storybook-header">
          <div class="storybook-title" id="storybookTitle">
            Your storybook will appear here
          </div>
          <div class="storybook-pill" id="storybookPill">
            Ready for bedtime
          </div>
        </div>

        <div class="storybook-body">
          <div class="storybook-page" id="storybookPage">
            <div class="storybook-placeholder" id="storybookPlaceholder">
              üí´ When you generate a story, it will be displayed here in a book-style view.
              <br /><br />
              Page 1 will show a cover illustration when available.
            </div>
          </div>
        </div>

        <div class="moral-box" id="moralBox" style="display:none;">
          <span class="moral-label">Moral:</span>
          <span id="moralText"></span>
        </div>

        <div class="storybook-footer">
          <span class="badge">Tip: Turn your phone sideways for a wider ‚Äústorybook‚Äù feel.</span>
          <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="copyStoryBtn" class="pager-btn" disabled>Copy</button>
            <button id="downloadStoryBtn" class="pager-btn" disabled>Download .txt</button>
            <button id="saveStoryBtn" class="pager-btn" disabled>Save story</button>
            <div class="pager-controls">
              <button id="prevPage" class="pager-btn" disabled>‚Äπ Prev</button>
              <span id="pageInfo">Page 0 of 0</span>
              <button id="nextPage" class="pager-btn" disabled>Next ‚Ä∫</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="status" style="text-align:center; margin-top:10px;">
      Prototype preview ‚Äì illustrations are generated on the server to keep your API key safe.
    </div>
    <div id="authStatus" class="status" style="text-align:center; margin-top:4px;">
      Sign in to group saved stories under your account (on this device).
    </div>

    <div id="savedStoriesSection" class="saved-stories">
      <h2>My saved stories (this device)</h2>
      <div class="saved-stories-note">
        Stories are stored in this browser and synced to the cloud for signed-in accounts.
      </div>
      <div id="savedStoriesList" class="saved-stories-list">
        <div class="status">No stories saved yet.</div>
      </div>
    </div>
  </div>

  <!-- Netlify Identity widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <script>
    let storyPages = [];
    let currentPageIndex = 0;
    let currentMoralLine = "";
    let currentIllustrationPrompts = [];
    let coverImageUrl = null;

    // metadata for the current story
    let lastChildName = "";
    let lastAge = "";
    let lastTheme = "";
    let lastStyle = "";
    let lastLength = "";

    // saved stories (local representation)
    let savedStories = [];

    const btn = document.getElementById("generateBtn");
    const statusEl = document.getElementById("status");
    const titleEl = document.getElementById("storybookTitle");
    const pillEl = document.getElementById("storybookPill");
    const pageEl = document.getElementById("storybookPage");
    const placeholderEl = document.getElementById("storybookPlaceholder");
    const moralBox = document.getElementById("moralBox");
    const moralText = document.getElementById("moralText");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");
    const authBtn = document.getElementById("authBtn");
    const authStatus = document.getElementById("authStatus");
    const saveStoryBtn = document.getElementById("saveStoryBtn");
    const savedStoriesList = document.getElementById("savedStoriesList");
    const copyStoryBtn = document.getElementById("copyStoryBtn");
    const downloadStoryBtn = document.getElementById("downloadStoryBtn");

    // ---------- helpers for auth + storage ----------

    function getCurrentIdentityUser() {
      if (typeof netlifyIdentity === "undefined") return null;
      return netlifyIdentity.currentUser();
    }

    function getStorageKeyForUser() {
      let userId = "guest";
      const user = getCurrentIdentityUser();
      if (user) {
        userId = user.id || user.email || "guest";
      }
      return "dreamtales_stories_" + userId;
    }

    function loadStoriesFromStorage() {
      const key = getStorageKeyForUser();
      try {
        const raw = localStorage.getItem(key);
        savedStories = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error reading local stories:", e);
        savedStories = [];
      }
      renderSavedStories();
    }

    function saveStoriesToStorage() {
      const key = getStorageKeyForUser();
      try {
        localStorage.setItem(key, JSON.stringify(savedStories));
      } catch (e) {
        console.error("Error saving local stories:", e);
      }
    }

    function mapCloudStoryToLocal(s) {
      if (!s) return null;
      return {
        id: s.id,
        title: s.title,
        childName: s.child_name,
        age: s.age,
        theme: s.theme,
        style: s.style,
        length: s.length,
        createdAt: s.created_at,
        pages: s.pages,
        moral: s.moral,
        coverImageUrl: s.cover_image_url
      };
    }

    async function callCloudStories(method, payload) {
      const user = getCurrentIdentityUser();
      if (!user) {
        throw new Error("Not signed in");
      }
      const token = await user.jwt(); // Netlify Identity JWT

      const res = await fetch("/.netlify/functions/cloud-stories", {
        method,
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: payload ? JSON.stringify(payload) : undefined
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = {};
      }

      if (!res.ok) {
        throw new Error(data.error || "Cloud stories error");
      }

      return data;
    }

    async function loadCloudStoriesForUser() {
      const user = getCurrentIdentityUser();
      if (!user) {
        // fall back to local-only for guests
        loadStoriesFromStorage();
        return;
      }

      try {
        const data = await callCloudStories("GET");
        const stories = (data.stories || []).map(mapCloudStoryToLocal).filter(Boolean);

        savedStories = stories;
        saveStoriesToStorage();
        renderSavedStories();
        statusEl.textContent = "Loaded cloud stories ‚òÅÔ∏è";
      } catch (e) {
        console.error("Cloud load failed:", e);
        statusEl.textContent = "Using local stories (cloud fetch failed)";
        loadStoriesFromStorage();
      }
    }

    // ---------- UI render functions ----------

    function renderSavedStories() {
      if (!savedStoriesList) return;
      savedStoriesList.innerHTML = "";

      if (!savedStories.length) {
        const empty = document.createElement("div");
        empty.className = "status";
        empty.textContent = "No stories saved yet.";
        savedStoriesList.appendChild(empty);
        return;
      }

      savedStories.forEach(story => {
        const item = document.createElement("div");
        item.className = "saved-story-item";
        item.dataset.id = story.id;

        const titleSpan = document.createElement("span");
        titleSpan.textContent = story.title || `Story for ${story.childName || "child"}`;

        const metaSpan = document.createElement("span");
        metaSpan.className = "saved-story-meta";
        const date = story.createdAt ? new Date(story.createdAt) : null;
        const dateStr = date ? date.toLocaleDateString() : "";
        metaSpan.textContent = `${story.childName || "Child"} ‚Ä¢ ${story.theme || ""} ‚Ä¢ ${dateStr}`;

        item.appendChild(titleSpan);
        item.appendChild(metaSpan);

        item.addEventListener("click", () => {
          loadStoryIntoViewer(story.id);
        });

        savedStoriesList.appendChild(item);
      });
    }

    function renderPage() {
      if (storyPages.length === 0) {
        pageEl.innerHTML = "";
        placeholderEl.style.display = "block";
        pageInfo.textContent = "Page 0 of 0";
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        moralBox.style.display = "none";
        saveStoryBtn.disabled = true;
        if (copyStoryBtn) copyStoryBtn.disabled = true;
        if (downloadStoryBtn) downloadStoryBtn.disabled = true;
        return;
      }

      placeholderEl.style.display = "none";
      pageEl.innerHTML = "";

      const isFirstPage = currentPageIndex === 0;
      const isLastPage = currentPageIndex === storyPages.length - 1;

      if (isFirstPage && coverImageUrl) {
        const img = document.createElement("img");
        img.src = coverImageUrl;
        img.alt = "Story cover illustration";
        img.className = "page-image";
        pageEl.appendChild(img);
      }

      const pageText = storyPages[currentPageIndex];
      pageText.forEach(sentence => {
        const p = document.createElement("p");
        p.textContent = sentence;
        pageEl.appendChild(p);
      });

      pageEl.classList.remove("page-fade");
      void pageEl.offsetWidth;
      pageEl.classList.add("page-fade");

      pageInfo.textContent = `Page ${currentPageIndex + 1} of ${storyPages.length}`;
      prevPageBtn.disabled = currentPageIndex === 0;
      nextPageBtn.disabled = currentPageIndex === storyPages.length - 1;

      if (isLastPage && currentMoralLine) {
        moralText.textContent = currentMoralLine;
        moralBox.style.display = "block";
      } else {
        moralBox.style.display = "none";
      }

      const hasStory = storyPages.length > 0;
      saveStoryBtn.disabled = !hasStory;
      if (copyStoryBtn) copyStoryBtn.disabled = !hasStory;
      if (downloadStoryBtn) downloadStoryBtn.disabled = !hasStory;
    }

    function loadStoryIntoViewer(storyId) {
      const story = savedStories.find(s => s.id === storyId);
      if (!story) return;

      storyPages = story.pages || [];
      currentMoralLine = story.moral || "";
      coverImageUrl = story.coverImageUrl || null;
      currentPageIndex = 0;

      lastChildName = story.childName || "";
      lastAge = story.age || "";
      lastTheme = story.theme || "";
      lastStyle = story.style || "";
      lastLength = story.length || "";

      titleEl.textContent = story.title || `Bedtime story for ${lastChildName || "your child"}`;
      pillEl.textContent = `${story.theme || "Story"} ‚Ä¢ ${story.style || ""}`;

      renderPage();
      statusEl.textContent = "Loaded saved story.";
    }

    // ---------- navigation & utilities ----------

    prevPageBtn.addEventListener("click", () => {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        renderPage();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPageIndex < storyPages.length - 1) {
        currentPageIndex++;
        renderPage();
      }
    });

    function sentenceRangeForLength(length) {
      if (length === "Short") return "4‚Äì6 sentences";
      if (length === "Long") return "14‚Äì20 sentences";
      return "8‚Äì12 sentences";
    }

    function getFullStoryText() {
      if (!storyPages.length) return "";

      const headerLines = [];
      if (lastChildName) headerLines.push(`Child: ${lastChildName}${lastAge ? " (age " + lastAge + ")" : ""}`);
      if (lastTheme || lastStyle) headerLines.push(`Theme: ${lastTheme || ""} | Style: ${lastStyle || ""}`);
      if (lastLength) headerLines.push(`Length: ${lastLength}`);

      const storyLines = [];
      storyPages.forEach(page => {
        const text = page.join(" ").trim();
        if (text) storyLines.push(text);
      });

      const moralLine = currentMoralLine ? `Moral: ${currentMoralLine}` : "";

      return [
        (headerLines.join("\n") || "Bedtime story"),
        "",
        ...storyLines,
        "",
        moralLine
      ].join("\n");
    }

    async function copyCurrentStory() {
      if (!storyPages.length) return;
      const text = getFullStoryText();
      if (!text) return;

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.style.position = "fixed";
          textarea.style.left = "-9999px";
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
        }
        statusEl.textContent = "Story copied to clipboard ‚úî";
      } catch (e) {
        console.error("Copy failed:", e);
        statusEl.textContent = "Could not copy story: " + e.message;
      }
    }

    function downloadCurrentStory() {
      if (!storyPages.length) return;
      const text = getFullStoryText();
      if (!text) return;

      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const safeName = lastChildName ? `dreamtales_${lastChildName}.txt` : "dreamtales_story.txt";
      a.href = url;
      a.download = safeName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      statusEl.textContent = "Story downloaded as text file ‚úî";
    }

    if (copyStoryBtn) {
      copyStoryBtn.addEventListener("click", copyCurrentStory);
    }

    if (downloadStoryBtn) {
      downloadStoryBtn.addEventListener("click", downloadCurrentStory);
    }

    // ---------- save story (local + cloud) ----------

    async function saveCurrentStory() {
      if (!storyPages.length) return;

      // local representation
      const localId = Date.now().toString();
      const localTitle = lastChildName ? `Story for ${lastChildName}` : "Bedtime story";

      let localStory = {
        id: localId,
        title: localTitle,
        childName: lastChildName,
        age: lastAge,
        theme: lastTheme,
        style: lastStyle,
        length: lastLength,
        createdAt: new Date().toISOString(),
        pages: storyPages,
        moral: currentMoralLine,
        coverImageUrl
      };

      savedStories.unshift(localStory);
      saveStoriesToStorage();
      renderSavedStories();
      statusEl.textContent = "Story saved locally ‚úî";

      const user = getCurrentIdentityUser();
      if (!user) {
        return; // guest users only get local save
      }

      // cloud payload
      const cloudPayload = {
        title: localTitle,
        childName: lastChildName,
        age: lastAge,
        theme: lastTheme,
        style: lastStyle,
        length: lastLength,
        moral: currentMoralLine,
        pages: storyPages,
        coverImageUrl
      };

      try {
        const data = await callCloudStories("POST", cloudPayload);
        if (data.story) {
          const cloudStory = mapCloudStoryToLocal(data.story);

          // replace local copy with the cloud version (proper id + timestamps)
          savedStories = [
            cloudStory,
            ...savedStories.filter(s => s.id !== localId)
          ];
          saveStoriesToStorage();
          renderSavedStories();
          statusEl.textContent = "Story saved in the cloud ‚òÅÔ∏è and locally ‚úî";
        }
      } catch (e) {
        console.error("Cloud save failed:", e);
        statusEl.textContent = "Saved locally; cloud save failed: " + e.message;
      }
    }

    if (saveStoryBtn) {
      saveStoryBtn.addEventListener("click", () => {
        saveCurrentStory();
      });
    }

    // ---------- story generation & images ----------

   async function generateCoverIllustration(childName, age, theme, illustrationPrompts) {
  if (!illustrationPrompts || illustrationPrompts.length === 0) return;

  const firstPrompt = illustrationPrompts[0];
  const styleHint =
    "children's book illustration, soft watercolor, warm pastel colors, cute and gentle, simple background, no text, no words, 4:5 aspect ratio";

  const prompt = `${firstPrompt}. ${styleHint}. Story about ${childName}, a ${age}-year-old child learning about ${theme}.`;

  try {
    statusEl.textContent += " | Generating cover illustration‚Ä¶";

    const response = await fetch("/.netlify/functions/illustrations", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const dataText = await response.text();
    let data = {};
    try {
      data = dataText ? JSON.parse(dataText) : {};
    } catch (e) {
      console.error("Non-JSON cover response:", dataText);
      statusEl.textContent += " (cover image error: non-JSON response from server)";
      return;
    }

    // If the function failed, show whatever error we can find
    if (!response.ok) {
      const msg =
        data.error ||
        data.message ||
        (typeof dataText === "string" ? dataText.slice(0, 120) + "‚Ä¶" : "unknown error");
      console.error("Cover illustration error (not ok):", data);
      statusEl.textContent += " (cover image error: " + msg + ")";
      return;
    }

    // Try to find a usable image URL in multiple shapes
    let url = data.url;

    // Case 1: function returned raw OpenAI response with data[0].b64_json
    if (!url && data.data && Array.isArray(data.data) && data.data[0]) {
      const item = data.data[0];
      if (item.url) {
        url = item.url;
      } else if (item.b64_json) {
        url = `data:image/png;base64,${item.b64_json}`;
      }
    }

    if (!url) {
      console.error("Cover illustration: no usable URL in response:", data);
      statusEl.textContent += " (cover image error: no usable image in response)";
      return;
    }

    coverImageUrl = url;
    renderPage();
    statusEl.textContent += " | Cover ready üåü";
  } catch (err) {
    console.error("Cover illustration exception:", err);
    statusEl.textContent += " (error loading cover image: " + err.message + ")";
  }
}


    async function generateStory() {
      const childName = document.getElementById("childName").value.trim();
      const age = document.getElementById("age").value.trim();
      const theme = document.getElementById("theme").value;
      const style = document.getElementById("style").value;
      const length = document.getElementById("length").value;

      if (!childName || !age) {
        alert("Please enter the child's name and age.");
        return;
      }

      lastChildName = childName;
      lastAge = age;
      lastTheme = theme;
      lastStyle = style;
      lastLength = length;

      btn.disabled = true;
      saveStoryBtn.disabled = true;
      if (copyStoryBtn) copyStoryBtn.disabled = true;
      if (downloadStoryBtn) downloadStoryBtn.disabled = true;

      statusEl.textContent = "Creating a magical story...";
      titleEl.textContent = "Writing a story for " + childName + "‚Ä¶";
      pillEl.textContent = theme + " ‚Ä¢ " + style;
      storyPages = [];
      currentPageIndex = 0;
      currentMoralLine = "";
      currentIllustrationPrompts = [];
      coverImageUrl = null;
      renderPage();

      const range = sentenceRangeForLength(length);

      const userContent = `
Create a bedtime story for a child.

Child's Name: ${childName}
Age: ${age}
Theme (moral): ${theme}
Style: ${style}
Length: ${length}

Rules:
1. Use simple, age-appropriate language for a child of this age.
2. Include the child‚Äôs name 4‚Äì6 times naturally.
3. Keep the tone calm, gentle, and encouraging, suitable for bedtime.
4. Add 1‚Äì2 cute or magical elements (e.g., friendly animals, stars, moon, talking toys).
5. Write the main story in ${range}, as one continuous block of text. Do not label the sentences.
6. At the end, write one clear sentence starting exactly with 'Moral:' that explains the lesson of the story.
7. After the moral, add a new section titled 'Illustration Prompts:' and list 4 bullet-point prompts describing key scenes for an illustrator or image model.
      `.trim();

      try {
        const response = await fetch("/.netlify/functions/story", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content:
                  "You are a gentle, creative kids‚Äô bedtime story writer. You write safe, soothing, age-appropriate stories for children. Your stories always have a clear positive moral. You avoid anything scary or disturbing."
              },
              { role: "user", content: userContent }
            ]
          })
        });

        const data = await response.json();

        if (!response.ok) {
          console.error("Story API error:", data);
          throw new Error(data.error?.message || data.error || "Story API error");
        }

        let storyRaw = data.choices?.[0]?.message?.content?.trim() || "No story generated.";

        let mainText = storyRaw;
        let moralLine = "";
        let illustrationPrompts = [];

        const moralMatch = storyRaw.match(/Moral:\s*(.*)/i);
        if (moralMatch) {
          moralLine = moralMatch[1].trim();
        }

        const illuSplit = mainText.split(/Illustration Prompts:/i);
        if (illuSplit.length > 1) {
          mainText = illuSplit[0].trim();
          const illuBlock = illuSplit[1];
          const lines = illuBlock
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.length > 0);

          illustrationPrompts = lines
            .filter(l => !/^Moral:/i.test(l))
            .map(l => l.replace(/^[\-‚Ä¢\d. ]+/, ""))
            .slice(0, 6);
        }

        mainText = mainText.replace(/Moral:\s*.*$/mi, "").trim();

        const sentenceRegex = /[^.!?]+[.!?]/g;
        const matches = mainText.match(sentenceRegex);
        const sentences = (matches || [mainText])
          .map(s => s.trim())
          .filter(s => s.length > 0);

        storyPages = sentences.map(s => [s]);
        currentMoralLine = moralLine;
        currentIllustrationPrompts = illustrationPrompts;
        currentPageIndex = 0;
        renderPage();

        titleEl.textContent = "Bedtime story for " + childName;
        statusEl.textContent = "Story ready ‚ú® Cover will appear if image generation succeeds.";

        if (currentIllustrationPrompts.length > 0) {
          generateCoverIllustration(childName, age, theme, currentIllustrationPrompts);
        }

        saveStoryBtn.disabled = false;
        if (copyStoryBtn) copyStoryBtn.disabled = false;
        if (downloadStoryBtn) downloadStoryBtn.disabled = false;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Something went wrong: " + err.message;
        titleEl.textContent = "Could not generate story";
        storyPages = [];
        currentPageIndex = 0;
        currentMoralLine = "";
        currentIllustrationPrompts = [];
        coverImageUrl = null;
        renderPage();
      } finally {
        btn.disabled = false;
      }
    }

    // ---------- auth UI ----------

    function updateAuthUI(user) {
      if (!authBtn || !authStatus) return;
      if (user) {
        const name = user.user_metadata && user.user_metadata.full_name;
        authBtn.textContent = "Log out";
        authStatus.textContent = `Signed in as ${name || user.email}. Stories sync to the cloud.`;
      } else {
        authBtn.textContent = "Sign in";
        authStatus.textContent = "Sign in to sync stories across devices.";
      }
    }

    if (typeof netlifyIdentity !== "undefined") {
      netlifyIdentity.on("init", user => {
        updateAuthUI(user);
        loadCloudStoriesForUser();
      });

      netlifyIdentity.on("login", user => {
        updateAuthUI(user);
        netlifyIdentity.close();
        loadCloudStoriesForUser();
      });

      netlifyIdentity.on("logout", () => {
        updateAuthUI(null);
        loadStoriesFromStorage();
      });

      netlifyIdentity.init();
    } else {
      loadStoriesFromStorage();
    }

    if (authBtn) {
      authBtn.addEventListener("click", () => {
        if (!netlifyIdentity) return;
        const user = getCurrentIdentityUser();
        if (user) {
          netlifyIdentity.logout();
        } else {
          netlifyIdentity.open("login");
        }
      });
    }

    btn.addEventListener("click", generateStory);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    }
  </script>
</body>
</html>

