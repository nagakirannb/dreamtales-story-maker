<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DreamTales ‚Äì Bedtime Story Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#020617" />
  <style>
    :root {
      --midnight: #020617;
      --night-gradient-start: #020617;
      --night-gradient-end: #0b1220;
      --accent-gold: #f4d27a;
      --accent-gold-soft: rgba(244, 210, 122, 0.18);
      --card-bg: rgba(15, 23, 42, 0.88);
      --border: rgba(148, 163, 184, 0.55);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, rgba(56, 189, 248, 0.12) 0, transparent 45%),
        radial-gradient(circle at bottom, rgba(244, 210, 122, 0.12) 0, transparent 50%),
        linear-gradient(to bottom, var(--night-gradient-start), var(--night-gradient-end));
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-main);
    }

    .app-shell {
      width: 100%;
      max-width: 1040px;
      margin: 16px;
      padding: 12px;
      border-radius: 18px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.85));
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.55),
        0 0 0 1px rgba(148, 163, 184, 0.2);
      position: relative;
      overflow: hidden;
    }

    .app-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(248, 250, 252, 0.13) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(248, 250, 252, 0.09) 0, transparent 60%);
      opacity: 0.5;
      pointer-events: none;
      z-index: 0;
    }

    .app-shell-inner {
      position: relative;
      z-index: 1;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .brand-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #fefce8 0, #facc15 40%, #eab308 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow:
        0 0 0 2px rgba(24, 37, 66, 0.6),
        0 10px 25px rgba(15, 23, 42, 0.6);
    }

    .brand-text {
      font-weight: 700;
      color: #f9fafb;
      font-size: 18px;
    }

    .brand-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .auth-btn {
      width: auto;
      padding-inline: 14px;
      margin-top: 0;
      font-size: 13px;
      white-space: nowrap;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      padding-block: 8px;
      cursor: pointer;
    }

    .auth-btn:hover {
      background: rgba(15, 23, 42, 1);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.6);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow:
        0 12px 30px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.3);
      padding: 18px 18px 22px;
      border: 1px solid rgba(15, 23, 42, 0.9);
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px;
      color: #f9fafb;
    }

    .subtitle {
      color: var(--text-muted);
      margin-bottom: 16px;
      font-size: 13px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
      color: #e5e7eb;
      font-size: 13px;
    }

    input, select, button {
      width: 100%;
      margin-top: 6px;
      padding: 9px 11px;
      border-radius: 11px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 14px;
      font-family: inherit;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
    }

    input::placeholder {
      color: rgba(148, 163, 184, 0.9);
    }

    input:focus, select:focus {
      outline: 2px solid rgba(244, 210, 122, 0.75);
      border-color: rgba(244, 210, 122, 0.9);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    button {
      margin-top: 18px;
      background: linear-gradient(to right, #facc15, #f97316);
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.1s ease, filter 0.1s ease;
      color: #42210b;
    }

    button:hover {
      box-shadow: 0 8px 20px rgba(248, 250, 252, 0.15);
      transform: translateY(-1px);
      filter: brightness(1.02);
    }

    button:disabled {
      opacity: 0.55;
      cursor: wait;
      box-shadow: none;
      transform: none;
    }

    .status {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* STORYBOOK PANEL */

    .storybook {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: radial-gradient(circle at top left, #0b1220, #020617);
      border-radius: 22px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow:
        0 26px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(15, 23, 42, 0.9);
      padding: 16px 16px 18px;
      position: relative;
      overflow: hidden;
    }

    .storybook::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle at 15% 15%, rgba(248, 250, 252, 0.12) 0, transparent 55%),
        radial-gradient(circle at 90% 20%, rgba(248, 250, 252, 0.09) 0, transparent 60%);
      opacity: 0.55;
      pointer-events: none;
      z-index: 0;
    }

    .storybook-header {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .storybook-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .header-home-btn {
      width: auto;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 4px 8px;
      cursor: pointer;
      display: none;
    }

    .header-home-btn:hover {
      background: rgba(15, 23, 42, 1);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.7);
    }

    .storybook-title {
      font-weight: 600;
      font-size: 14px;
      color: #e5e7eb;
      padding: 6px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.9), rgba(15,23,42,0.6));
      border: 1px solid rgba(148,163,184,0.3);
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 240px;
    }

    .storybook-header-right {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
    }

    .audio-bar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.8));
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 12px 24px rgba(15,23,42,0.85);
    }

    .audio-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      padding: 7px 14px;
      font-size: 12px;
      background: rgba(15,23,42,0.92);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .audio-btn-primary {
      background: linear-gradient(to right, #facc15, #fb923c);
      border-color: rgba(250,204,21,0.8);
      color: #42210b;
      font-weight: 600;
      box-shadow: 0 10px 20px rgba(248, 181, 63, 0.35);
    }

    .audio-btn-secondary {
      font-weight: 500;
    }

    .audio-btn:disabled {
      opacity: 0.55;
      box-shadow: none;
    }

    .audio-btn:hover:not(:disabled) {
      transform: translateY(-0.5px);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.7);
    }

    .music-select-compact {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 11px;
      padding: 6px 10px;
      max-width: 180px;
    }

    .storybook-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--accent-gold-soft);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.5);
      max-width: 210px;
    }

    .storybook-body {
      flex: 1;
      overflow: hidden;
      margin-top: 8px;
      padding-right: 4px;
      position: relative;
      z-index: 1;
    }

    .storybook-page {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      line-height: 1.8;
      font-size: 15px;
      color: #111827;
      white-space: pre-wrap;
      background:
        radial-gradient(circle at top, #fefce8 0, #f9fafb 42%, #fef3c7 100%);
      border-radius: 18px;
      padding: 18px 22px 20px;
      box-shadow:
        0 0 0 1px rgba(252, 211, 77, 0.7),
        0 18px 34px rgba(15, 23, 42, 0.65);
    }

    .storybook-page p {
      margin: 0 0 10px;
    }

    .storybook-page p:first-of-type::first-letter {
      font-size: 1.35em;
      font-weight: 700;
    }

    .page-fade {
      animation: pageFade 0.22s ease-out;
    }

    @keyframes pageFade {
      from { opacity: 0; transform: translateX(6px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    .page-image {
      width: 100%;
      max-height: 280px;
      object-fit: cover;
      border-radius: 16px;
      margin-bottom: 16px;
      background: #e5e7eb;
      border: 1px solid rgba(252, 211, 77, 0.9);
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.6),
        0 0 0 1px rgba(255,255,255,0.9);
    }

    .storybook-placeholder {
      margin-top: 30px;
      text-align: center;
      color: #4b5563;
      font-size: 13px;
    }

    .moral-box {
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fef9c3;
      border: 1px dashed #facc15;
      font-size: 13px;
      color: #4a3907;
      position: relative;
      z-index: 1;
      display: none;
    }

    .moral-label {
      font-weight: 700;
      margin-right: 4px;
    }

    .storybook-footer {
      margin-top: 10px;
      font-size: 12px;
      color: #d1d5db;
      border-top: 1px dashed rgba(148, 163, 184, 0.6);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
      font-size: 11px;
      color: var(--text-muted);
      max-width: 100%;
    }

    .music-hint {
      font-size: 11px;
      color: #9ca3af;
    }

    .pager-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
      margin: 0 auto;
    }

    .pager-btn {
      width: auto;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 11px;
      white-space: nowrap;
      flex: 0 0 auto;
      color: #111827;
    }

    .pager-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    #pageInfo {
      white-space: nowrap;
      display: inline-block;
      text-align: center;
      flex: 1 1 auto;
      font-weight: 500;
      color: #4b5563;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
      width: 100%;
      align-items: center;
    }

    .primary-btn,
    .secondary-btn,
    .ghost-btn {
      width: auto;
      flex: 1 1 140px;
      margin-top: 0;
      font-size: 13px;
    }

    .primary-btn {
      background: linear-gradient(to right, #facc15, #fb923c);
      color: #42210b;
      border: none;
    }

    .primary-btn:hover:not(:disabled) {
      box-shadow: 0 4px 14px rgba(248, 250, 252, 0.25);
    }

    .secondary-btn {
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .secondary-btn:hover:not(:disabled) {
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.7);
    }

    .ghost-btn {
      background: transparent;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    .ghost-btn:hover:not(:disabled) {
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 3px 10px rgba(15, 23, 42, 0.7);
    }

    .primary-btn:disabled,
    .secondary-btn:disabled,
    .ghost-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .saved-stories {
      margin-top: 16px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 14px;
      padding: 12px 16px 14px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.7);
      font-size: 13px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      position: relative;
      z-index: 1;
    }

    .saved-stories h2 {
      margin: 0 0 6px;
      font-size: 14px;
      color: #f9fafb;
    }

    .saved-stories-note {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .saved-stories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .saved-story-item {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      cursor: pointer;
      font-size: 12px;
      color: #e5e7eb;
      display: inline-flex;
      flex-direction: column;
      gap: 2px;
      min-width: 160px;
    }

    .saved-story-item span:first-child {
      font-weight: 600;
    }

    .saved-story-meta {
      font-size: 11px;
      color: #9ca3af;
    }

    .saved-story-item .delete-btn {
      margin-top: 4px;
      align-self: flex-start;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(127, 29, 29, 0.8);
      color: #fee2e2;
      cursor: pointer;
    }

    .saved-story-item .delete-btn:hover {
      background: rgba(127, 29, 29, 1);
    }

    /* Story mode (after generation) */
    .story-mode .layout {
      grid-template-columns: minmax(0, 1fr);
    }

    .story-mode .card,
    .story-mode #savedStoriesSection,
    .story-mode #authStatus {
      display: none;
    }

    .story-mode .storybook {
      max-width: 720px;
      margin: 0 auto;
    }

    .story-mode .header-home-btn {
      display: inline-block;
    }

    @media (max-width: 900px) {
      .story-mode .storybook {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="app-shell-inner">
      <div class="brand">
        <div class="brand-left">
          <div class="brand-icon">üåô</div>
          <div>
            <div class="brand-text">DreamTales ‚Äì Bedtime Story Maker</div>
            <div class="brand-subtitle">Magical, personalized stories for cozy nights.</div>
          </div>
        </div>
        <button id="authBtn" class="auth-btn">Sign in</button>
      </div>

      <div class="layout">
        <!-- LEFT: form -->
        <div class="card">
          <h1>Create a magical bedtime story</h1>
          <div class="subtitle">
            Add your child‚Äôs details, choose a moral and story type, and DreamTales will do the rest.
          </div>

          <label>Child's Name</label>
          <input id="childName" placeholder="e.g., Aby" />

          <label>Age</label>
          <input id="age" type="number" min="2" max="12" placeholder="e.g., 6" />

          <label>Theme (moral)</label>
          <select id="theme">
            <option>Kindness</option>
            <option>Honesty</option>
            <option>Courage</option>
            <option>Sharing</option>
            <option>Gratitude</option>
          </select>

          <label>Style</label>
          <select id="style">
            <option>Calm & Gentle</option>
            <option>Funny</option>
            <option>Magical Adventure</option>
            <option>Animal Friends</option>
          </select>

          <label>Language</label>
          <select id="language">
            <option value="English" selected>English</option>
            <option value="Hindi">Hindi</option>
            <option value="Spanish">Spanish</option>
            <option value="French">French</option>
            <option value="German">German</option>
          </select>
          
          <label>Narrator voice</label>
          <select id="voice">
            <option value="soft" selected>Soothing voice</option>
            <option value="calm-male">Calm male voice</option>
          </select>

          <label>Story Type (chapters)</label>
          <select id="storyType">
            <option value="short">Short Story (1 gentle chapter)</option>
            <option value="adventure" selected>Magical Adventure (3 chapters)</option>
            <option value="epic">Epic Bedtime Tale (6 chapters)</option>
          </select>

          <button id="generateBtn">‚ú® Generate Story</button>

          <div id="status" class="status"></div>
        </div>

        <!-- RIGHT: story viewer -->
        <div class="storybook">
          <div class="storybook-header">
            <div class="storybook-header-left">
              <button id="homeBtn" class="header-home-btn" type="button">‚Üê New story</button>
              <div class="storybook-title" id="storybookTitle">
                Your storybook will appear here
              </div>
            </div>
            <div class="storybook-header-right">
              <div class="audio-bar">
                <button id="listenStoryBtn" class="audio-btn audio-btn-primary" disabled>
                  üîä Listen
                </button>

                <button id="musicToggleBtn" class="audio-btn audio-btn-secondary" disabled>
                  üéµ Music off
                </button>

                <select id="musicPreset" class="music-select-compact" disabled>
                  <option value="dreamtales" selected>DreamTales ‚Äì Night lullaby</option>
                  <option value="twinkle">Twinkle</option>
                  <option value="pianos">Soft piano ambience</option>
                  <option value="flute">Flute</option>
                  <option value="none">No music</option>
                </select>
              </div>

              <div class="storybook-pill" id="storybookPill">
                Ready for bedtime
              </div>
            </div>
          </div>

          <div class="storybook-body">
            <div class="storybook-page" id="storybookPage">
              <div class="storybook-placeholder" id="storybookPlaceholder">
                üí´ When you generate a story, it will be displayed here in a book-style view.
                <br /><br />
                After that, the page will switch into a full ‚Äúreading mode‚Äù with audio and music options.
              </div>
            </div>
          </div>

          <div class="moral-box" id="moralBox">
            <span class="moral-label">Moral:</span>
            <span id="moralText"></span>
          </div>

          <div class="storybook-footer">
            <span class="badge">
              Tip: Swipe left or right on the story page (on touch devices) to flip pages.
            </span>

            <span class="music-hint" id="musicHint">
              üéµ Use the music controls above to set the mood.
            </span>

            <div class="pager-row">
              <button id="prevPage" class="pager-btn" disabled>‚Äπ Prev</button>
              <span id="pageInfo">Page 0 of 0</span>
              <button id="nextPage" class="pager-btn" disabled>Next ‚Ä∫</button>
            </div>

            <div class="actions-row">
              <button id="downloadPdfBtn" class="primary-btn" disabled>Download PDF</button>
              <button id="saveStoryBtn" class="secondary-btn" disabled>Save story</button>
              <button id="feedbackBtn" class="ghost-btn" type="button">
                üí¨ Give feedback
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="status" style="text-align:center; margin-top:10px;">
        Private beta ‚Äì stories are generated with OpenAI and stored only on this device (plus cloud sync for signed-in testers).
      </div>
      <div id="authStatus" class="status" style="text-align:center; margin-top:4px;">
        Sign in to group saved stories under your account (on this device).
      </div>

      <div id="savedStoriesSection" class="saved-stories">
        <h2>My saved stories (this device)</h2>
        <div class="saved-stories-note">
          Stories are stored in this browser and synced to the cloud for signed-in accounts. Tap a story to reopen it.
        </div>
        <div id="savedStoriesList" class="saved-stories-list">
          <div class="status">No stories saved yet.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Background music and TTS audio -->
  <audio id="bgMusic" loop preload="auto"></audio>
  <audio id="storyAudio" preload="auto"></audio>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    let storyPages = [];
    let currentPageIndex = 0;
    let currentMoralLine = "";
    let currentIllustrationPrompts = [];
    let coverImageUrl = null;

    // swipe tracking
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;

    // TTS audio state
    let storyAudioUrl = null;
    let isTtsPlaying = false;
    let isTtsLoading = false;

    // background music state
    let musicEnabled = false;

    // metadata
    let lastChildName = "";
    let lastAge = "";
    let lastTheme = "";
    let lastStyle = "";
    let lastStoryType = "adventure";
    let lastLanguage = "English";
    let sentencesPerPage = 4;

    // saved stories
    let savedStories = [];

    const appShell = document.querySelector(".app-shell");

    const btn = document.getElementById("generateBtn");
    const statusEl = document.getElementById("status");
    const titleEl = document.getElementById("storybookTitle");
    const pillEl = document.getElementById("storybookPill");
    const pageEl = document.getElementById("storybookPage");
    const placeholderEl = document.getElementById("storybookPlaceholder");
    const moralBox = document.getElementById("moralBox");
    const moralText = document.getElementById("moralText");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");
    const authBtn = document.getElementById("authBtn");
    const authStatus = document.getElementById("authStatus");
    const saveStoryBtn = document.getElementById("saveStoryBtn");
    const savedStoriesList = document.getElementById("savedStoriesList");
    const downloadPdfBtn = document.getElementById("downloadPdfBtn");
    const languageSelect = document.getElementById("language");
    const listenStoryBtnHeader = document.getElementById("listenStoryBtn");
    const listenStoryBtnFooter = document.getElementById("listenStoryBtnFooter"); // may be null
    const musicToggleBtn = document.getElementById("musicToggleBtn");
    const homeBtn = document.getElementById("homeBtn");
    const storyTypeSelect = document.getElementById("storyType");
    const bgMusicEl = document.getElementById("bgMusic");
    const storyAudioEl = document.getElementById("storyAudio");
    const feedbackBtn = document.getElementById("feedbackBtn");
    const musicPresetSelect = document.getElementById("musicPreset");
    const voiceSelect = document.getElementById("voice");

    const BG_MUSIC_BASE_VOLUME = 0.35;
    const BG_MUSIC_DUCKED_VOLUME = 0.14;

    const MUSIC_PRESETS = {
      dreamtales: "../Music/dreamtales-night.mp3",
      twinkle: "../Music/TwinkleTLS-lullaby-baby-sleep-music.mp3",
      pianos: "../Music/soft-piano-music-432727.mp3",
      flute: "../Music/krishna_flute.mp3",
      none: null
    };
    let currentMusicPreset = "dreamtales";

    // ----- Background music helpers -----

    function ensureMusicSource() {
      if (!bgMusicEl) return;

      const url = MUSIC_PRESETS[currentMusicPreset] || null;

      if (!url) {
        bgMusicEl.pause();
        bgMusicEl.removeAttribute("src");
        return;
      }

      if (!bgMusicEl.src || !bgMusicEl.src.endsWith(url)) {
        bgMusicEl.src = url;
      }
      bgMusicEl.loop = true;
      bgMusicEl.volume = BG_MUSIC_BASE_VOLUME;
    }

    function startBackgroundMusic() {
      if (!bgMusicEl) return;
      if (!MUSIC_PRESETS[currentMusicPreset]) return;

      ensureMusicSource();
      const playPromise = bgMusicEl.play();
      if (playPromise && typeof playPromise.then === "function") {
        playPromise.catch(err => {
          console.warn("Background music could not autoplay:", err);
          statusEl.textContent = "Tap Music again to start background audio.";
        });
      }
    }

    function stopBackgroundMusic() {
      if (!bgMusicEl) return;
      bgMusicEl.pause();
    }

    function duckMusicForTts() {
      if (!bgMusicEl) return;
      if (!MUSIC_PRESETS[currentMusicPreset]) return;

      ensureMusicSource();
      bgMusicEl.volume = BG_MUSIC_DUCKED_VOLUME;

      if (bgMusicEl.paused) {
        const p = bgMusicEl.play();
        if (p && typeof p.then === "function") {
          p.catch(err => {
            console.warn("BG music couldn't start during TTS:", err);
          });
        }
      }
    }

    function restoreMusicAfterTts() {
      if (!bgMusicEl) return;

      if (!musicEnabled || !MUSIC_PRESETS[currentMusicPreset]) {
        bgMusicEl.pause();
        return;
      }
      bgMusicEl.volume = BG_MUSIC_BASE_VOLUME;
    }

    // Top ‚ÄúMusic on/off‚Äù pill
    if (musicToggleBtn) {
      musicToggleBtn.addEventListener("click", () => {
        if (!storyPages.length) return;

        musicEnabled = !musicEnabled;
        if (musicEnabled && currentMusicPreset !== "none") {
          startBackgroundMusic();
          musicToggleBtn.textContent = "üéµ Music on";
        } else {
          stopBackgroundMusic();
          musicToggleBtn.textContent = "üéµ Music off";
        }
      });
    }

    // Dropdown for choosing track
    if (musicPresetSelect) {
      musicPresetSelect.addEventListener("change", () => {
        currentMusicPreset = musicPresetSelect.value || "none";

        if (!storyPages.length) return;

        if (!musicEnabled || currentMusicPreset === "none") {
          stopBackgroundMusic();
          return;
        }

        stopBackgroundMusic();
        startBackgroundMusic();
      });
    }

    // ---------- helpers for auth + storage ----------

    function getCurrentIdentityUser() {
      if (typeof netlifyIdentity === "undefined") return null;
      return netlifyIdentity.currentUser();
    }

    function getStorageKeyForUser() {
      let userId = "guest";
      const user = getCurrentIdentityUser();
      if (user) {
        userId = user.id || user.email || "guest";
      }
      return "dreamtales_stories_" + userId;
    }

    function loadStoriesFromStorage() {
      const key = getStorageKeyForUser();
      try {
        const raw = localStorage.getItem(key);
        savedStories = raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error("Error reading local stories:", e);
        savedStories = [];
      }
      renderSavedStories();
    }

    function saveStoriesToStorage() {
      const key = getStorageKeyForUser();
      try {
        localStorage.setItem(key, JSON.stringify(savedStories));
      } catch (e) {
        console.error("Error saving local stories:", e);
      }
    }

    function mapCloudStoryToLocal(s) {
      if (!s) return null;
      return {
        id: s.id,
        title: s.title,
        childName: s.child_name,
        age: s.age,
        theme: s.theme,
        style: s.style,
        length: s.length,
        createdAt: s.created_at,
        pages: s.pages,
        moral: s.moral,
        coverImageUrl: s.cover_image_url
      };
    }

    async function callCloudStories(method, payload) {
      const user = getCurrentIdentityUser();
      if (!user) {
        throw new Error("Not signed in");
      }
      const token = await user.jwt();

      const res = await fetch("/.netlify/functions/cloud-stories", {
        method,
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: payload ? JSON.stringify(payload) : undefined
      });

      let data;
      try {
        data = await res.json();
      } catch (e) {
        data = {};
      }

      if (!res.ok) {
        throw new Error(data.error || "Cloud stories error");
      }

      return data;
    }

    async function loadCloudStoriesForUser() {
      const user = getCurrentIdentityUser();
      if (!user) {
        loadStoriesFromStorage();
        return;
      }

      try {
        const data = await callCloudStories("GET");
        const stories = (data.stories || []).map(mapCloudStoryToLocal).filter(Boolean);

        savedStories = stories;
        saveStoriesToStorage();
        renderSavedStories();
        statusEl.textContent = "Loaded cloud stories ‚òÅÔ∏è";
      } catch (e) {
        console.error("Cloud load failed:", e);
        statusEl.textContent = "Using local stories (cloud fetch failed)";
        loadStoriesFromStorage();
      }
    }

    // ---------- UI render functions ----------

    function renderSavedStories() {
      if (!savedStoriesList) return;
      savedStoriesList.innerHTML = "";

      if (!savedStories.length) {
        const empty = document.createElement("div");
        empty.className = "status";
        empty.textContent = "No stories saved yet.";
        savedStoriesList.appendChild(empty);
        return;
      }

      savedStories.forEach(story => {
        const item = document.createElement("div");
        item.className = "saved-story-item";
        item.dataset.id = story.id;

        const titleSpan = document.createElement("span");
        titleSpan.textContent = story.title || `Story for ${story.childName || "child"}`;

        const metaSpan = document.createElement("span");
        metaSpan.className = "saved-story-meta";
        const date = story.createdAt ? new Date(story.createdAt) : null;
        const dateStr = date ? date.toLocaleDateString() : "";
        const typeLabel = story.length || "";
        metaSpan.textContent =
          `${story.childName || "Child"} ‚Ä¢ ${story.theme || ""}` +
          (typeLabel ? ` ‚Ä¢ ${typeLabel}` : "") +
          (dateStr ? ` ‚Ä¢ ${dateStr}` : "");

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteStory(story.id);
        });

        item.appendChild(titleSpan);
        item.appendChild(metaSpan);
        item.appendChild(deleteBtn);

        item.addEventListener("click", () => {
          loadStoryIntoViewer(story.id);
          enterStoryMode();
        });

        savedStoriesList.appendChild(item);
      });
    }

    function renderPage() {
      if (storyPages.length === 0) {
        pageEl.innerHTML = "";
        placeholderEl.style.display = "block";
        pageInfo.textContent = "Page 0 of 0";
        prevPageBtn.disabled = true;
        nextPageBtn.disabled = true;
        moralBox.style.display = "none";
        saveStoryBtn.disabled = true;
        if (downloadPdfBtn) downloadPdfBtn.disabled = true;
        if (listenStoryBtnHeader) listenStoryBtnHeader.disabled = true;
        if (listenStoryBtnFooter) listenStoryBtnFooter.disabled = true;
        if (musicToggleBtn) musicToggleBtn.disabled = true;
        if (musicPresetSelect) musicPresetSelect.disabled = true;
        return;
      }

      placeholderEl.style.display = "none";
      pageEl.innerHTML = "";

      const isFirstPage = currentPageIndex === 0;
      const isLastPage = currentPageIndex === storyPages.length - 1;

      if (isFirstPage && coverImageUrl) {
        const img = document.createElement("img");
        img.src = coverImageUrl;
        img.alt = "Story cover illustration";
        img.className = "page-image";
        pageEl.appendChild(img);
      }

      const pageText = storyPages[currentPageIndex];
      pageText.forEach(sentence => {
        const p = document.createElement("p");
        p.textContent = sentence;
        pageEl.appendChild(p);
      });

      pageEl.classList.remove("page-fade");
      void pageEl.offsetWidth;
      pageEl.classList.add("page-fade");

      pageInfo.textContent = `Page ${currentPageIndex + 1} of ${storyPages.length}`;
      prevPageBtn.disabled = currentPageIndex === 0;
      nextPageBtn.disabled = currentPageIndex === storyPages.length - 1;

      if (isLastPage && currentMoralLine) {
        moralText.textContent = currentMoralLine;
        moralBox.style.display = "block";
      } else {
        moralBox.style.display = "none";
      }

      const hasStory = storyPages.length > 0;
      saveStoryBtn.disabled = !hasStory;
      if (downloadPdfBtn) downloadPdfBtn.disabled = !hasStory;
      if (listenStoryBtnHeader) listenStoryBtnHeader.disabled = !hasStory;
      if (listenStoryBtnFooter) listenStoryBtnFooter.disabled = !hasStory;
      if (musicToggleBtn) musicToggleBtn.disabled = !hasStory;
      if (musicPresetSelect) musicPresetSelect.disabled = !hasStory;
    }

    function loadStoryIntoViewer(storyId) {
      const story = savedStories.find(s => s.id === storyId);
      if (!story) return;

      storyPages = story.pages || [];
      currentMoralLine = story.moral || "";
      coverImageUrl = story.coverImageUrl || null;
      currentPageIndex = 0;

      lastChildName = story.childName || "";
      lastAge = story.age || "";
      lastTheme = story.theme || "";
      lastStyle = story.style || "";
      lastStoryType = story.length || "adventure";

      titleEl.textContent = story.title || `Bedtime story for ${lastChildName || "your child"}`;
      pillEl.textContent = `${story.theme || "Story"} ‚Ä¢ ${story.style || ""}`;

      resetStoryAudio();
      renderPage();
      statusEl.textContent = "Loaded saved story.";
    }

    function deleteStory(id) {
      savedStories = savedStories.filter(s => s.id !== id);
      saveStoriesToStorage();
      renderSavedStories();
      statusEl.textContent = "Story deleted.";
    }

    // ---------- navigation & swipe ----------

    prevPageBtn.addEventListener("click", () => {
      if (currentPageIndex > 0) {
        currentPageIndex--;
        renderPage();
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPageIndex < storyPages.length - 1) {
        currentPageIndex++;
        renderPage();
      }
    });

    function handleTouchStart(e) {
      if (!storyPages.length) return;
      if (!e.touches || e.touches.length !== 1) return;

      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
      touchStartTime = Date.now();
    }

    function handleTouchEnd(e) {
      if (!storyPages.length) return;
      const touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;

      const dx = touch.clientX - touchStartX;
      const dy = touch.clientY - touchStartY;
      const dt = Date.now() - touchStartTime;

      const minDistance = 40;
      const maxAngleRatio = 0.6;
      const maxDuration = 600;

      if (dt > maxDuration) return;
      if (Math.abs(dx) < minDistance) return;
      if (Math.abs(dy) > Math.abs(dx) * maxAngleRatio) return;

      if (dx < 0 && currentPageIndex < storyPages.length - 1) {
        currentPageIndex++;
        renderPage();
      }

      if (dx > 0 && currentPageIndex > 0) {
        currentPageIndex--;
        renderPage();
      }
    }

    const storybookBodyEl = document.querySelector(".storybook-body");
    if (storybookBodyEl) {
      storybookBodyEl.addEventListener("touchstart", handleTouchStart, { passive: true });
      storybookBodyEl.addEventListener("touchend", handleTouchEnd, { passive: true });
    }

    // ---------- Story type config ----------

    function storyConfigForType(type) {
      switch (type) {
        case "short":
          return {
            label: "Short Story (1 chapter)",
            sentenceRange: "4‚Äì6 sentences",
            perPage: 6
          };
        case "epic":
          return {
            label: "Epic Bedtime Tale (6 chapters)",
            sentenceRange: "18‚Äì24 sentences",
            perPage: 4
          };
        case "adventure":
        default:
          return {
            label: "Magical Adventure (3 chapters)",
            sentenceRange: "10‚Äì16 sentences",
            perPage: 4
          };
      }
    }

    function chunkSentencesIntoPages(sentences) {
      if (!sentences || !sentences.length) return [];
      const perPage = sentencesPerPage || 4;
      const pages = [];
      for (let i = 0; i < sentences.length; i += perPage) {
        pages.push(sentences.slice(i, i + perPage));
      }
      return pages;
    }

    // ---------- PDF helpers ----------

    function buildStoryPieces() {
      if (!storyPages.length) return null;

      const headerLines = [];
      if (lastChildName) {
        headerLines.push(
          `Child: ${lastChildName}${lastAge ? " (age " + lastAge + ")" : ""}`
        );
      }
      if (lastTheme || lastStyle) {
        headerLines.push(`Theme: ${lastTheme || ""} | Style: ${lastStyle || ""}`);
      }
      if (lastStoryType) {
        headerLines.push(`Story Type: ${lastStoryType}`);
      }
      if (lastLanguage) {
        headerLines.push(`Language: ${lastLanguage}`);
      }

      const paragraphs = storyPages
        .map(page => page.join(" ").trim())
        .filter(Boolean);

      const moralLine = currentMoralLine ? `Moral: ${currentMoralLine}` : "";

      return { headerLines, paragraphs, moralLine };
    }

    function downloadStoryPdf() {
      if (!storyPages.length) return;

      const pieces = buildStoryPieces();
      if (!pieces) return;

      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("PDF engine is still loading. Please try again.");
        return;
      }

      const doc = new jsPDF({
        orientation: "p",
        unit: "pt",
        format: "a4"
      });

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const marginX = 50;
      const marginTop = 70;
      const marginBottom = 50;
      const usableWidth = pageWidth - marginX * 2;
      const usableHeight = pageHeight - marginTop - marginBottom;

      let y = marginTop;
      let pageNumber = 1;

      function drawHeader() {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.text("DreamTales ‚Äì Bedtime Story Maker", marginX, y);
        y += 22;

        doc.setFont("helvetica", "normal");
        doc.setFontSize(11);
        pieces.headerLines.forEach(line => {
          doc.text(line, marginX, y);
          y += 16;
        });

        y += 8;
      }

      function drawFooter() {
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text(
          `Page ${pageNumber}`,
          pageWidth / 2,
          pageHeight - marginBottom / 2,
          { align: "center" }
        );
      }

      drawHeader();

      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      const lineHeight = 16;

      const bodyLines = [];
      pieces.paragraphs.forEach((para, idx) => {
        const wrapped = doc.splitTextToSize(para, usableWidth);
        bodyLines.push(...wrapped);
        if (idx < pieces.paragraphs.length - 1) bodyLines.push("");
      });

      if (pieces.moralLine) {
        bodyLines.push("");
        bodyLines.push(pieces.moralLine);
      }

      bodyLines.forEach(line => {
        if (y + lineHeight > marginTop + usableHeight) {
          drawFooter();
          doc.addPage();
          pageNumber++;
          y = marginTop;
          drawHeader();
          doc.setFont("helvetica", "normal");
          doc.setFontSize(12);
        }
        doc.text(line, marginX, y);
        y += line === "" ? lineHeight / 2 : lineHeight;
      });

      drawFooter();

      const safeName = lastChildName ? `dreamtales_${lastChildName}.pdf` : "dreamtales_story.pdf";
      doc.save(safeName);
      statusEl.textContent = "Story downloaded as PDF ‚úî";
    }

    if (downloadPdfBtn) {
      downloadPdfBtn.addEventListener("click", downloadStoryPdf);
    }

    // ---------- TTS helpers ----------

    function getLanguageCode(language) {
      switch (language) {
        case "Hindi": return "hi-IN";
        case "Spanish": return "es-ES";
        case "French": return "fr-FR";
        case "German": return "de-DE";
        default: return "en-US";
      }
    }

    function getStoryTextForTts() {
      if (!storyPages.length) return "";
      const storyLines = [];
      storyPages.forEach(page => {
        const text = page.join(" ").trim();
        if (text) storyLines.push(text);
      });
      if (currentMoralLine) {
        storyLines.push("");
        storyLines.push(currentMoralLine);
      }
      return storyLines.join("\n");
    }

    function resetStoryAudio() {
      if (!storyAudioEl) return;
      try {
        storyAudioEl.pause();
        storyAudioEl.currentTime = 0;
      } catch {}
      if (storyAudioUrl) {
        URL.revokeObjectURL(storyAudioUrl);
        storyAudioUrl = null;
      }
      storyAudioEl.removeAttribute("src");
      isTtsPlaying = false;
      isTtsLoading = false;
      if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "üîä Listen";
      if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "üîä Listen";
    }

    function stopStoryAudio() {
      if (!storyAudioEl) return;
      storyAudioEl.pause();
      storyAudioEl.currentTime = 0;
      isTtsPlaying = false;
      if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "üîä Listen";
      if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "üîä Listen";
    }

    function getSelectedVoiceId() {
      if (!voiceSelect) return "alloy";
      const choice = voiceSelect.value || "soft";
      switch (choice) {
        case "calm-male": return "verse";
        case "soft":
        default: return "alloy";
      }
    }

    async function fetchTtsAudio() {
      const text = getStoryTextForTts();
      if (!text) throw new Error("No story text available for audio.");

      const langCode = getLanguageCode(lastLanguage || "English");
      const voiceId = getSelectedVoiceId();
      
      const res = await fetch("/.netlify/functions/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          text,
          languageCode: langCode,
          voice: voiceId
        })
      });

      if (!res.ok) {
        let msg = "TTS error";
        try {
          const errJson = await res.json();
          msg = errJson.error || JSON.stringify(errJson);
        } catch {
          msg = res.statusText || msg;
        }
        throw new Error(msg);
      }

      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      let blob;

      if (contentType.includes("application/json")) {
        const data = await res.json();
        if (!data.audio) {
          throw new Error("No 'audio' field in TTS JSON response");
        }

        const byteChars = atob(data.audio);
        const byteNumbers = new Array(byteChars.length);
        for (let i = 0; i < byteChars.length; i++) {
          byteNumbers[i] = byteChars.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        blob = new Blob([byteArray], { type: "audio/mpeg" });
      } else {
        const audioBuffer = await res.arrayBuffer();
        blob = new Blob([audioBuffer], { type: "audio/mpeg" });
      }

      if (storyAudioUrl) {
        URL.revokeObjectURL(storyAudioUrl);
      }
      storyAudioUrl = URL.createObjectURL(blob);
      storyAudioEl.src = storyAudioUrl;
    }

    if (storyAudioEl) {
      storyAudioEl.addEventListener("ended", () => {
        isTtsPlaying = false;
        if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "üîä Listen";
        if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "üîä Listen";
        restoreMusicAfterTts();
      });
    }

    async function handleListenClick() {
      if (!storyPages.length || isTtsLoading) return;

      if (isTtsPlaying) {
        stopStoryAudio();
        restoreMusicAfterTts();
        return;
      }

      try {
        isTtsLoading = true;
        if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "‚è≥ Preparing audio...";
        if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "‚è≥ Preparing audio...";
        statusEl.textContent = "Preparing high-quality bedtime audio...";

        duckMusicForTts();

        if (!storyAudioEl.src) {
          await fetchTtsAudio();
        }

        await storyAudioEl.play();
        isTtsPlaying = true;

        if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "‚èπ Stop audio";
        if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "‚èπ Stop audio";
        statusEl.textContent = "Listening mode: story audio is playing.";
      } catch (err) {
        console.error("TTS play error", err);
        statusEl.textContent = "Audio could not start: " + err.message;
        if (listenStoryBtnHeader) listenStoryBtnHeader.textContent = "üîä Listen";
        if (listenStoryBtnFooter) listenStoryBtnFooter.textContent = "üîä Listen";
        restoreMusicAfterTts();
      } finally {
        isTtsLoading = false;
      }
    }

    if (listenStoryBtnHeader) {
      listenStoryBtnHeader.addEventListener("click", handleListenClick);
    }
    if (listenStoryBtnFooter) {
      listenStoryBtnFooter.addEventListener("click", handleListenClick);
    }

    // ---------- save story (local + cloud) ----------

    async function saveCurrentStory() {
      if (!storyPages.length) return;

      const localId = Date.now().toString();
      const localTitle = lastChildName ? `Story for ${lastChildName}` : "Bedtime story";

      let localStory = {
        id: localId,
        title: localTitle,
        childName: lastChildName,
        age: lastAge,
        theme: lastTheme,
        style: lastStyle,
        length: storyConfigForType(lastStoryType).label,
        createdAt: new Date().toISOString(),
        pages: storyPages,
        moral: currentMoralLine,
        language: lastLanguage,
        coverImageUrl
      };

      savedStories.unshift(localStory);
      saveStoriesToStorage();
      renderSavedStories();
      statusEl.textContent = "Story saved locally ‚úî";

      const user = getCurrentIdentityUser();
      if (!user) {
        return;
      }

      const cloudPayload = {
        title: localTitle,
        childName: lastChildName,
        age: lastAge,
        theme: lastTheme,
        style: lastStyle,
        length: storyConfigForType(lastStoryType).label,
        moral: currentMoralLine,
        pages: storyPages,
        coverImageUrl
      };

      try {
        const data = await callCloudStories("POST", cloudPayload);
        if (data.story) {
          const cloudStory = mapCloudStoryToLocal(data.story);

          savedStories = [
            cloudStory,
            ...savedStories.filter(s => s.id !== localId)
          ];
          saveStoriesToStorage();
          renderSavedStories();
          statusEl.textContent = "Story saved in the cloud ‚òÅÔ∏è and locally ‚úî";
        }
      } catch (e) {
        console.error("Cloud save failed:", e);
        statusEl.textContent = "Saved locally; cloud save failed: " + e.message;
      }
    }

    if (saveStoryBtn) {
      saveStoryBtn.addEventListener("click", () => {
        saveCurrentStory();
      });
    }

    // ---------- story mode helpers ----------

    function enterStoryMode() {
      if (!appShell) return;
      appShell.classList.add("story-mode");
    }

    function exitStoryMode() {
      if (!appShell) return;
      appShell.classList.remove("story-mode");
      stopStoryAudio();
      resetStoryAudio();
      stopBackgroundMusic();
      musicEnabled = false;
      if (musicToggleBtn) musicToggleBtn.textContent = "üéµ Music off";
      statusEl.textContent = "Ready for a new bedtime story.";
    }

    if (homeBtn) {
      homeBtn.addEventListener("click", () => {
        exitStoryMode();
      });
    }

    // ---------- cover illustration ----------

    async function generateCoverIllustration(childName, age, theme, illustrationPrompts) {
      try {
        const sceneHint =
          Array.isArray(illustrationPrompts) && illustrationPrompts.length
            ? ` Focus on this scene: ${illustrationPrompts[0]}`
            : "";

        const prompt = `
DreamTales-style cover illustration for a gentle children's bedtime story.

Child's name: ${childName || "the child"}
Age: ${age || "6"}
Theme: ${theme || "Kindness"}

Requirements:
- Soft, cozy, storybook illustration
- Warm night-time colors, stars or moonlight
- Child-friendly, no scary elements
- Looks like a book cover
- No text on the image.${sceneHint}
        `.trim();

        const res = await fetch("/.netlify/functions/illustrations", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          console.error("Illustration API error:", data);
          statusEl.textContent =
            (statusEl.textContent || "") + " (Illustration unavailable right now.)";
          return;
        }

        const url = data.imageUrl || data.url;
        if (!url) {
          console.error("No image URL in illustration response:", data);
          statusEl.textContent =
            (statusEl.textContent || "") + " (Illustration unavailable right now.)";
          return;
        }

        coverImageUrl = url;

        if (currentPageIndex === 0 && storyPages.length) {
          renderPage();
        }

        statusEl.textContent = (statusEl.textContent || "") + " Artwork added üé®";
      } catch (err) {
        console.error("Cover illustration error:", err);
        statusEl.textContent =
          (statusEl.textContent || "") + " (Illustration unavailable right now.)";
      }
    }

    // ---------- story generation ----------

    async function generateStory() {
      const childName = document.getElementById("childName").value.trim();
      const age = document.getElementById("age").value.trim();
      const theme = document.getElementById("theme").value;
      const style = document.getElementById("style").value;
      const language = languageSelect ? languageSelect.value : "English";
      const storyType = storyTypeSelect ? storyTypeSelect.value : "adventure";

      if (!childName || !age) {
        alert("Please enter the child's name and age.");
        return;
      }

      stopStoryAudio();
      resetStoryAudio();
      stopBackgroundMusic();
      musicEnabled = false;
      if (musicToggleBtn) musicToggleBtn.textContent = "üéµ Music off";

      lastChildName = childName;
      lastAge = age;
      lastTheme = theme;
      lastStyle = style;
      lastLanguage = language;
      lastStoryType = storyType;

      const config = storyConfigForType(storyType);
      const range = config.sentenceRange;
      sentencesPerPage = config.perPage;

      btn.disabled = true;
      saveStoryBtn.disabled = true;
      if (downloadPdfBtn) downloadPdfBtn.disabled = true;
      if (listenStoryBtnHeader) listenStoryBtnHeader.disabled = true;
      if (listenStoryBtnFooter) listenStoryBtnFooter.disabled = true;
      if (musicToggleBtn) musicToggleBtn.disabled = true;
      if (musicPresetSelect) musicPresetSelect.disabled = true;

      statusEl.textContent = "Creating a magical story...";
      titleEl.textContent = "Writing a story for " + childName + "‚Ä¶";
      pillEl.textContent = `${theme} ‚Ä¢ ${style} ‚Ä¢ ${config.label}`;

      storyPages = [];
      currentPageIndex = 0;
      currentMoralLine = "";
      currentIllustrationPrompts = [];
      coverImageUrl = null;
      renderPage();

      const userContent = `
Create a bedtime story for a child.

Child's Name: ${childName}
Age: ${age}
Theme (moral): ${theme}
Style: ${style}
Story Type: ${config.label}
Target language: ${language}

Rules:
1. Write the ENTIRE story in the target language: ${language}. Do NOT mix languages, except where specified.
2. Use simple, age-appropriate language for a child of this age.
3. Include the child‚Äôs name 4‚Äì6 times naturally.
4. Keep the tone calm, gentle, and encouraging, suitable for bedtime.
5. Add 1‚Äì2 cute or magical elements (e.g., friendly animals, stars, moon, talking toys).
6. Write the main story in ${range}, as one continuous block of text. Do not label the sentences.
7. At the end, write one clear sentence that explains the lesson of the story. This sentence MUST start with the English label 'Moral:' followed by a space, and then the moral sentence in the target language.
8. After the moral, add a new section titled 'Illustration Prompts:' and list 4 bullet-point prompts describing key scenes for an illustrator or image model.
`.trim();

      try {
        const response = await fetch("/.netlify/functions/story", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            messages: [
              {
                role: "system",
                content:
                  "You are a gentle, creative kids‚Äô bedtime story writer. You write safe, soothing, age-appropriate stories for children. Your stories always have a clear positive moral. You avoid anything scary or disturbing."
              },
              { role: "user", content: userContent }
            ]
          })
        });

        const data = await response.json();

        if (!response.ok) {
          console.error("Story API error:", data);
          throw new Error(data.error?.message || data.error || "Story API error");
        }

        let storyRaw = data.choices?.[0]?.message?.content?.trim() || "No story generated.";

        let mainText = storyRaw;
        let moralLine = "";
        let illustrationPrompts = [];

        const moralMatch = storyRaw.match(/Moral:\s*(.*)/i);
        if (moralMatch) {
          moralLine = moralMatch[1].trim();
        }

        const illuSplit = mainText.split(/Illustration Prompts:/i);
        if (illuSplit.length > 1) {
          mainText = illuSplit[0].trim();
          const illuBlock = illuSplit[1];
          const lines = illuBlock
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.length > 0);

          illustrationPrompts = lines
            .filter(l => !/^Moral:/i.test(l))
            .map(l => l.replace(/^[\-‚Ä¢\d. ]+/, ""))
            .slice(0, 6);
        }

        mainText = mainText.replace(/Moral:\s*.*$/mi, "").trim();

        const sentenceRegex = /[^.!?]+[.!?]/g;
        const matches = mainText.match(sentenceRegex);
        const sentences = (matches || [mainText])
          .map(s => s.trim())
          .filter(s => s.length > 0);

        storyPages = chunkSentencesIntoPages(sentences);

        currentMoralLine = moralLine;
        currentIllustrationPrompts = illustrationPrompts;
        currentPageIndex = 0;
        renderPage();

        // generate cover art now that we have prompts
        generateCoverIllustration(childName, age, theme, currentIllustrationPrompts);

        titleEl.textContent = "Bedtime story for " + childName;
        statusEl.textContent =
          "Story ready ‚ú® Enjoy reading, listening to the audio, or downloading the PDF.";

        saveStoryBtn.disabled = false;
        if (downloadPdfBtn) downloadPdfBtn.disabled = false;
        if (listenStoryBtnHeader) listenStoryBtnHeader.disabled = false;
        if (listenStoryBtnFooter) listenStoryBtnFooter.disabled = false;
        if (musicToggleBtn) musicToggleBtn.disabled = false;
        if (musicPresetSelect) musicPresetSelect.disabled = false;

        enterStoryMode();

        // music starts off; user turns it on with the button
        musicEnabled = false;
        if (musicToggleBtn) musicToggleBtn.textContent = "üéµ Music off";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Something went wrong: " + err.message;
        titleEl.textContent = "Could not generate story";
        storyPages = [];
        currentPageIndex = 0;
        currentMoralLine = "";
        currentIllustrationPrompts = [];
        coverImageUrl = null;
        renderPage();
      } finally {
        btn.disabled = false;
      }
    }

    // ---------- auth UI ----------

    function updateAuthUI(user) {
      if (!authBtn || !authStatus) return;
      if (user) {
        const name = user.user_metadata && user.user_metadata.full_name;
        authBtn.textContent = "Log out";
        authStatus.textContent = `Signed in as ${name || user.email}. Stories sync to the cloud.`;
      } else {
        authBtn.textContent = "Sign in";
        authStatus.textContent = "Sign in to sync stories across devices.";
      }
    }

    if (typeof netlifyIdentity !== "undefined") {
      netlifyIdentity.on("init", user => {
        updateAuthUI(user);
        loadCloudStoriesForUser();
      });

      netlifyIdentity.on("login", user => {
        updateAuthUI(user);
        netlifyIdentity.close();
        loadCloudStoriesForUser();
      });

      netlifyIdentity.on("logout", () => {
        updateAuthUI(null);
        loadStoriesFromStorage();
      });

      netlifyIdentity.init();
    } else {
      loadStoriesFromStorage();
    }

    if (authBtn) {
      authBtn.addEventListener("click", () => {
        if (!netlifyIdentity) return;
        const user = getCurrentIdentityUser();
        if (user) {
          netlifyIdentity.logout();
        } else {
          netlifyIdentity.open("login");
        }
      });
    }

    btn.addEventListener("click", generateStory);

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(console.error);
    }

    // ---------- Feedback button ----------

    const FEEDBACK_FORM_URL = "https://docs.google.com/forms/d/1Fq94O9JP0LOSDo3YjScjwVvvtcc1Ji76TIc1giiOvb0/viewform";

    if (feedbackBtn) {
      feedbackBtn.addEventListener("click", () => {
        window.open(FEEDBACK_FORM_URL, "_blank", "noopener");
      });
    }
  </script>
</body>
</html>
